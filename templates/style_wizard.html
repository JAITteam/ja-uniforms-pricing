{% extends "base.html" %}
{% block title %}Style Cost Calculator - J.A Uniforms{% endblock %}
{% block content %}
{% if view_mode %}
<div style="background: #fef3c7; border: 2px solid #f59e0b; padding: 1rem; margin-bottom: 1.5rem; border-radius: 8px; text-align: center;">
    <strong style="color: #92400e;">üëÅÔ∏è VIEW ONLY MODE</strong>
    <span style="color: #a16207;"> - You can view this style but cannot make changes</span>
</div>
{% endif %}

<div class="toolbar">
  <div class="group">
    {% if not view_mode %}
    <button id="saveBtn" class="btn btn-primary btn-pill">
      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"/>
      </svg>
      Save Style
    </button>
    {% endif %}
    <button class="btn btn-outline-secondary btn-pill" onclick="exportCurrentStyle()">
      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
      </svg>
      Export
    </button>
  </div>
  
  <div style="flex: 1; max-width: 400px; position: relative;">
    <input type="text" id="styleSearch" class="form-control" placeholder="Search by vendor style or name..." autocomplete="off">
    <div id="searchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e5e5e5; border-top: none; max-height: 300px; overflow-y: auto; display: none; z-index: 1000;"></div>
  </div>
  
  <span class="chip">Works with /api/style (load & save)</span>
</div>

<div class="row g-3">
  <!-- LEFT: Main Editor (2 columns) -->
  <div class="col-lg-8">

    <!-- BASIC INFO PANEL -->
    <div class="panel">
      <div class="ph">BASIC INFO</div>
      <div class="pb">
        <div class="row g-3">
          <div class="col-lg-6">
            <div class="kv">
              <label>Vendor</label>
              <input id="vendor" class="form-control md" value="JA UNIFORMS" readonly>
            </div>
            <div class="kv">
              <label>Vendor Code</label>
              <input id="vendor_code" class="form-control xs" value="V999" readonly>
            </div>
            <div class="kv">
              <label>Base Item #</label>
              <input id="base_item_number" class="form-control xs">
              <label>Variant Code #</label>
              <input id="variant_code" class="form-control xs">
              <label>Fabric Code #</label>
              <input id="fabric_code" class="form-control xs" readonly>
            </div>
            <div class="kv">
              <label>Vendor Style</label>
              <input id="vendor_style" class="form-control lg" readonly>
            </div>
            <div class="kv">
              <label>Style name</label>
              <input id="style_name" class="form-control" placeholder="Enter style name" style="flex: 1;">
            </div>
            <div class="kv">
              <label>Gender</label>
              <select id="gender" class="form-select sm">
                <option value="">Select Gender</option>
                <option value="MENS">MENS</option>
                <option value="LADIES">LADIES</option>
                <option value="UNISEX">UNISEX</option>
              </select>
            </div>
          </div>
          
          <!-- ENHANCED IMAGE SECTION -->
          <div class="col-lg-6">
            <div class="image-section">
              <div id="imageGallery"></div>
              <input type="file" id="imageUpload" accept="image/png,image/jpeg,image/jpg,image/gif" multiple style="display: none;">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MATERIALS COST PANEL -->
    <div class="panel" id="materialsPanel">
      <div class="ph">MATERIALS COST</div>
      <div class="pb table-like">
        <!-- Fabric Row -->
        <div class="kv">
          <label>Vendor</label>
          <select class="form-select md" data-fabric-vendor-id>
            <option value="">Select Fabric Vendor</option>
            {% for v in fabric_vendors %}
            <option value="{{ v.id }}" data-fship="{{ v.f_ship_cost or 0 }}">{{ v.name }}</option>
            {% endfor %}
          </select>
          <label>Fabric</label>
          <select class="form-select md" data-fabric-id>
            <option value="">Select Fabric</option>
            <option value="__ADD_NEW__" style="color: #10b981; font-weight: 600;">+ Add New Fabric</option>
            {% for f in fabrics %}
            <option value="{{ f.id }}" data-cost="{{ f.cost_per_yard }}" data-vendor="{{ f.fabric_vendor_id }}" data-fabric-code="{{ f.fabric_code or '' }}">{{ f.name }}</option>
            {% endfor %}
          </select>
          
          <label style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
            <input type="checkbox" data-fabric-sublimation style="width: auto; margin: 0;">
            Sub.
          </label>
          
          <label>Avg.Cost/yd</label>
          <input class="form-control w-110 text-end" type="number" step="0.01" min="0" data-fabric-cost readonly>
          
          <label>Avg.Yds</label>
          <input class="form-control w-110 text-end" type="number" step="0.01" min="0" data-fabric-yds>

          <label>F.Ship</label>
          <input class="form-control text-end" type="number" step="0.01" min="0" data-fabric-fship readonly style="width: 70px;">
          
          <label>Total</label>
          <input class="form-control w-110 text-end" disabled data-fabric-total>
        </div>

        <div class="kv">
          <span class="linklike" id="addFabric">Fabric</span>
        </div>

        <!-- Notion Row -->
        <div class="kv">
          <label>Vendor</label>
          <select class="form-select md" data-notion-vendor-id>
            <option value="">Select Notion Vendor</option>
            {% for v in notion_vendors %}
            <option value="{{ v.id }}">{{ v.name }}</option>
            {% endfor %}
          </select>
        
          <label>Notion</label>
          <select class="form-select md" data-notion-id>
            <option value="">Select Notion</option>
            <option value="__ADD_NEW__" style="color: #10b981; font-weight: 600;">+ Add New Notion</option>
            {% for n in notions %}
            <option value="{{ n.id }}" data-cost="{{ n.cost_per_unit }}" data-vendor="{{ n.notion_vendor_id }}">{{ n.name }}</option>
            {% endfor %}
          </select>
          
          <label>Avg.Cost</label>
          <input class="form-control w-110 text-end" type="number" step="0.01" min="0" data-notion-cost readonly>
          
          <label>Qty</label>
          <input class="form-control qty text-end" type="number" step="0.01" min="0" data-notion-qty>
          
          <label>Total</label>
          <input class="form-control w-110 text-end" disabled data-notion-total>
        </div>

        <div class="kv">
          <span class="linklike" id="addNotion">Notion</span>
        </div>

        <div class="kv">
          <span class="text-muted">Avg. Label(s) Cost</span>
          <input class="form-control w-110 text-end" id="label_cost" type="number" step="0.01" min="0" value="{{ default_label_cost }}" readonly title="Edit in Master Costs">
        </div>

        <div class="sumline">
          <span>TOTAL MATERIALS COST</span>
          <strong id="sumMaterials">$0.00</strong>
        </div>
      </div>
    </div>

    <!-- LABOR COST PANEL -->
    <div class="panel" id="laborPanel">
      <div class="ph">LABOR COST</div>
      <div class="pb table-like" id="laborRows">
        {% for labor in labor_ops %}
        <div class="labor-row" data-labor-row data-labor-name="{{ labor.name }}">
          <span class="labor-name">{{ labor.name }}</span>
          <span class="labor-label">{% if labor.cost_type == 'hourly' %}Avg.Cost/Hr{% else %}Avg.Cost{% endif %}</span>
          <input class="form-control text-end" type="number" step="0.01" min="0"
                 value="{% if labor.cost_type == 'flat_rate' %}{{ labor.fixed_cost }}{% elif labor.cost_type == 'hourly' %}{{ labor.cost_per_hour }}{% else %}{{ labor.cost_per_piece }}{% endif %}" 
                 data-labor-rate readonly>
          <span class="labor-label">{% if labor.cost_type == 'hourly' %}Hours{% else %}Qty{% endif %}</span>
          <input class="form-control text-end" type="number" step="{% if labor.cost_type == 'hourly' %}0.01{% else %}1{% endif %}" min="0" data-labor-qoh>
          <span class="labor-label">Total</span>
          <input class="form-control text-end" disabled data-labor-total>
        </div>
        {% endfor %}

        <div class="labor-row labor-row-cleaning">
          <span class="labor-name">Cleaning & Ironing</span>
          <span class="labor-label">Type</span>
          <select class="form-select" id="garment_type">
            <option value="">Select Garment Type</option>
            {% for gt in garment_types %}
            <option value="{{ gt }}">{{ gt }}</option>
            {% endfor %}
          </select>
          <span class="labor-label">Total</span>
          <input class="form-control text-end" type="number" step="0.01" min="0" id="cleaning_cost" readonly>
        </div>

        <div class="sumline">
          <span>TOTAL LABOR COST</span>
          <strong id="sumLabor">$0.00</strong>
        </div>
      </div>
    </div>

    <!-- TOTAL COST PANEL -->
    <div class="panel">
      <div class="ph">TOTAL COST</div>
      <div class="pb">
        <div class="total-cost-row">
          <span class="total-cost-label">Size Range</span>
          <select class="form-select" id="size_range_id" style="width: 150px;">
            <option value="">Select Size Range</option>
            {% for sr in size_ranges %}
            <option value="{{ sr.id }}" 
                    data-name="{{ sr.name }}"
                    data-regular="{{ sr.regular_sizes }}" 
                    data-extended="{{ sr.extended_sizes }}"
                    data-markup="{{ sr.extended_markup_percent }}">
              {{ sr.name }}
            </option>
            {% endfor %}
          </select>
          <span class="chip">Regular Sizes</span>
          <input class="form-control text-center" id="regular_sizes_display" disabled style="width: 80px;">
          <span class="total-cost-label">Total Cost Price for Reg. Sizes</span>
          <input class="form-control text-end" id="total_reg" disabled style="width: 90px;">
        </div>
        <div class="total-cost-row">
          <span class="total-cost-label"></span>
          <span style="width: 150px;"></span>
          <span class="chip" id="extended_label">Extended Sizes (+15%)</span>
          <input class="form-control text-center" id="extended_sizes_display" disabled style="width: 80px;">
          <span class="total-cost-label">Total Cost Price for Ex. Sizes</span>
          <input class="form-control text-end" id="total_ext" disabled style="width: 90px;">
        </div>
      </div>
    </div>

    <!-- ADDITIONAL INFO PANEL -->
    <div class="panel">
      <div class="ph">ADDITIONAL INFO</div>
      <div class="pb">
        <div class="row g-3 mb-3">
          <!-- Colors Section -->
          <div class="col-md-4">
            <label class="form-label fw-bold" style="font-size: 0.875rem;">Color</label>
            <div class="d-flex gap-2 mb-2">
              <select id="color_dropdown" class="form-select form-select-sm" style="flex: 1;">
                <option value="">Select Color</option>
              </select>
              <button class="btn btn-primary btn-sm" type="button" onclick="addSelectedColor()">Add</button>
            </div>
            <select multiple class="form-select mb-2" style="height:100px; font-size: 0.8rem;" id="color_list"></select>
            <button class="btn btn-sm btn-danger" onclick="removeSelectedColors()">Remove Selected</button>
            <div class="input-group input-group-sm mt-2">
              <input id="new_color_input" class="form-control form-control-sm" placeholder="Or type new color...">
              <button class="btn btn-success btn-sm" type="button" onclick="addNewColor()">Create & Add</button>
            </div>
          </div>

          <!-- Variables Section -->
          <div class="col-md-4">
            <label class="form-label fw-bold" style="font-size: 0.875rem;">Variable</label>
            <div class="d-flex gap-2 mb-2">
              <select id="variable_dropdown" class="form-select form-select-sm" style="flex: 1;">
                <option value="">Select Variable</option>
              </select>
              <button class="btn btn-primary btn-sm" type="button" onclick="addSelectedVariable()">Add</button>
            </div>
            <select multiple class="form-select mb-2" style="height:100px; font-size: 0.8rem;" id="variable_list"></select>
            <button class="btn btn-sm btn-danger" onclick="removeSelectedVariables()">Remove Selected</button>
            <div class="input-group input-group-sm mt-2">
              <input id="new_variable_input" class="form-control form-control-sm" placeholder="Or type new variable...">
              <button class="btn btn-success btn-sm" type="button" onclick="addNewVariable()">Create & Add</button>
            </div>
          </div>
          <!-- Clients Section -->
          <div class="col-md-4">
            <label class="form-label fw-bold" style="font-size: 0.875rem;">Client</label>
            <div class="d-flex gap-2 mb-2">
              <input type="text" id="client_input" class="form-control form-control-sm" list="client_datalist" placeholder="Type to search..." style="flex: 1;" autocomplete="off">
              <datalist id="client_datalist"></datalist>
              <button class="btn btn-primary btn-sm" type="button" onclick="addSelectedClient()">Add</button>
            </div>
            <select multiple class="form-select mb-2" style="height:100px; font-size: 0.8rem;" id="client_list"></select>
            <button class="btn btn-sm btn-danger" onclick="removeSelectedClients()">Remove Selected</button>
          </div>
        </div>
        <!-- Pricing Section - ULTRA COMPACT -->
        <div class="kv mb-3" style="background: #f8f9fa; padding: 0.5rem 0.75rem; border-radius: 4px;">
          <strong style="font-size: 0.8rem; color: #555;">Pricing:</strong>

          <span style="font-size: 0.75rem; color: #888;">(Estimate:</span>
          <input id="margin" class="form-control text-end" type="number" step="1" value="60" min="0" max="95" style="width: 55px; padding: 0.2rem 0.4rem; font-size: 0.8rem;">
          <span style="font-size: 0.75rem; color: #888;">%</span>
          <span style="margin: 0 0.3rem; color: #999; font-size: 0.75rem;">=</span>
          <input id="retail_price" class="form-control text-end" disabled style="width: 75px; padding: 0.2rem 0.4rem; background: white; font-size: 0.8rem; color: #888;">
          <span style="font-size: 0.75rem; color: #888;">)</span>

          <span style="margin: 0 0.75rem; color: #ddd;">|</span>

          <span style="font-size: 0.75rem; color: #333; font-weight: 600;">MARGIN</span>
          <input id="suggested_margin" class="form-control text-end" type="number" step="0.1" min="0" max="95" style="width: 60px; padding: 0.2rem 0.4rem; font-size: 0.8rem;">
          <span style="font-size: 0.75rem; color: #333;">%</span>

          <span style="margin: 0 0.3rem; color: #999; font-size: 0.75rem;">‚Üí</span>

          <span style="font-size: 0.75rem; color: #333; font-weight: 600;">SALE PRICE</span>
          <input id="suggested_price" class="form-control text-end" type="number" step="0.01" min="0" style="width: 80px; padding: 0.2rem 0.4rem; font-size: 0.8rem; font-weight: 600; background: #f8f9fa;" readonly>
        </div>
        
        <div class="kv mb-3">
          <span class="text-muted">Shipping Cost</span>
          <input id="shipping_cost" class="form-control w-110 text-end" type="number" step="0.01" min="0" value="{{ default_shipping_cost }}" readonly title="Edit in Master Costs">
        </div>
        
        <div>
          <label class="form-label fw-bold" style="font-size: 0.875rem;">Notes</label>
          <textarea id="notes" class="form-control" rows="4" placeholder="Additional notes, special instructions, or details about this style..."></textarea>
        </div>
      </div>
    </div>

  </div>

  <!-- RIGHT: Snapshot Panel -->
  <div class="col-lg-4" style="position: relative;">
    <div class="right-sticky panel snapshot" style="position: sticky; top: 190px; max-height: calc(100vh - 160px); overflow-y: auto;">
      <div class="ph" style="position: sticky; top: 0; z-index: 10;">
        <span>SNAPSHOT</span>
        <button type="button" class="copy-btn" id="copySnapshotBtn">
          <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
          </svg>
          Copy
        </button>
      </div>
      <div class="pb">
        <div class="snapshot-row">
          <span class="snapshot-label">Vendor Code:</span>
          <span class="snapshot-value" id="snap_vendor_code">V999</span>
        </div>
        
        <div class="snapshot-row">
          <span class="snapshot-label">Vendor Style:</span>
          <span class="snapshot-value" id="snap_vendor_style">(vendor style)</span>
        </div>
        
        <div class="snapshot-row">
          <span class="snapshot-label">Style Name:</span>
          <span class="snapshot-value" id="snap_style_name">(style name)</span>
        </div>
        
        <hr>
        
        <div class="snapshot-row" id="snap_reg_row">
          <span class="snapshot-label" id="snap_reg_label">Sizes:</span>
          <span class="snapshot-value snapshot-cost" id="snap_reg_cost">$0.00</span>
        </div>
        
        <div class="snapshot-row" id="snap_ext_row" style="display: none;">
          <span class="snapshot-label" id="snap_ext_label">Sizes:</span>
          <span class="snapshot-value snapshot-cost" id="snap_ext_cost">$0.00</span>
        </div>
        
        <hr>
        
        <div class="snapshot-row snapshot-colors-row">
          <span class="snapshot-label">Color:</span>
          <span class="snapshot-value" id="snap_colors"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Image Zoom Modal -->
<div id="imageModal" class="image-modal">
  <span class="close-modal" onclick="closeImageModal()">&times;</span>
  <img id="modalImage" src="" alt="Zoomed image">
</div>

<!-- Quick Add Fabric Modal -->
<div id="quickAddFabricModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
  <div style="background: white; padding: 2rem; border-radius: 12px; width: 400px; max-width: 90%;">
    <h3 style="margin: 0 0 1.5rem 0; color: #1e293b;">Add New Fabric</h3>
    
    <div style="margin-bottom: 1rem;">
      <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Fabric Name *</label>
      <input type="text" id="quick_fabric_name" class="form-control" placeholder="e.g., XANADU" style="width: 100%;">
    </div>
    
    <div style="margin-bottom: 1rem;">
      <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Fabric Code *</label>
      <input type="text" id="quick_fabric_code" class="form-control" placeholder="e.g., T1" style="width: 100%;">
    </div>
    
    <div style="margin-bottom: 1rem;">
      <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Cost per Yard *</label>
      <input type="number" id="quick_fabric_cost" class="form-control" step="0.01" min="0" placeholder="e.g., 6.50" style="width: 100%;">
    </div>
    
    <div style="margin-bottom: 1.5rem;">
      <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Vendor *</label>
      <select id="quick_fabric_vendor" class="form-select" style="width: 100%;">
        <option value="">Select Vendor</option>
        {% for v in fabric_vendors %}
        <option value="{{ v.id }}">{{ v.name }}</option>
        {% endfor %}
      </select>
    </div>
    
    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
      <button type="button" onclick="closeQuickAddFabric()" style="padding: 0.5rem 1rem; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
      <button type="button" onclick="saveQuickFabric()" style="padding: 0.5rem 1rem; border: none; background: #10b981; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">Save Fabric</button>
    </div>
  </div>
</div>

<!-- Quick Add Notion Modal -->
<div id="quickAddNotionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
  <div style="background: white; padding: 2rem; border-radius: 12px; width: 400px; max-width: 90%;">
    <h3 style="margin: 0 0 1.5rem 0; color: #1e293b;">Add New Notion</h3>
    
    <div style="margin-bottom: 1rem;">
      <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Notion Name *</label>
      <input type="text" id="quick_notion_name" class="form-control" placeholder="e.g., 18L SPORT BUTTON" style="width: 100%;">
    </div>
    
    <div style="margin-bottom: 1rem;">
      <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Cost per Unit *</label>
      <input type="number" id="quick_notion_cost" class="form-control" step="0.01" min="0" placeholder="e.g., 0.15" style="width: 100%;">
    </div>
    
    <div style="margin-bottom: 1.5rem;">
      <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Vendor *</label>
      <select id="quick_notion_vendor" class="form-select" style="width: 100%;">
        <option value="">Select Vendor</option>
        {% for v in notion_vendors %}
        <option value="{{ v.id }}">{{ v.name }}</option>
        {% endfor %}
      </select>
    </div>
    
    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
      <button type="button" onclick="closeQuickAddNotion()" style="padding: 0.5rem 1rem; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
      <button type="button" onclick="saveQuickNotion()" style="padding: 0.5rem 1rem; border: none; background: #10b981; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">Save Notion</button>
    </div>
  </div>
</div>

<script>
// Global sublimation cost from settings
window.SUBLIMATION_COST = parseFloat("{{ default_sublimation_cost }}") || 6.00;

// ============================================
// UPDATE SNAPSHOT DISPLAY
// ============================================
function updateSnapshotDisplay() {
    var vendorCode = document.getElementById('vendor_code');
    var snapVendorCode = document.getElementById('snap_vendor_code');
    if (vendorCode && snapVendorCode) {
        snapVendorCode.textContent = vendorCode.value || 'V999';
    }
    
    var vendorStyle = document.getElementById('vendor_style');
    var snapVendorStyle = document.getElementById('snap_vendor_style');
    if (vendorStyle && snapVendorStyle) {
        snapVendorStyle.textContent = vendorStyle.value || '(vendor style)';
    }
    
    var styleName = document.getElementById('style_name');
    var snapStyleName = document.getElementById('snap_style_name');
    if (styleName && snapStyleName) {
        snapStyleName.textContent = styleName.value || '(style name)';
    }
    
    var sizeRangeSelect = document.getElementById('size_range_id');
    var regRow = document.getElementById('snap_reg_row');
    var extRow = document.getElementById('snap_ext_row');
    
    if (sizeRangeSelect && sizeRangeSelect.value) {
        var selectedOption = sizeRangeSelect.options[sizeRangeSelect.selectedIndex];
        var regularSizes = selectedOption ? (selectedOption.dataset.regular || '') : '';
        var extendedSizes = selectedOption ? (selectedOption.dataset.extended || '') : '';
        
        var totalReg = document.getElementById('total_reg');
        var snapRegLabel = document.getElementById('snap_reg_label');
        var snapRegCost = document.getElementById('snap_reg_cost');
        
        if (snapRegLabel) snapRegLabel.textContent = 'Sizes ' + regularSizes + ' Cost:';
        if (snapRegCost && totalReg) snapRegCost.textContent = totalReg.value || '$0.00';
        if (regRow) regRow.style.display = 'flex';
        
        if (extendedSizes && extendedSizes.trim() !== '') {
            var totalExt = document.getElementById('total_ext');
            var snapExtLabel = document.getElementById('snap_ext_label');
            var snapExtCost = document.getElementById('snap_ext_cost');
            
            if (snapExtLabel) snapExtLabel.textContent = 'Sizes ' + extendedSizes + ' Cost:';
            if (snapExtCost && totalExt) snapExtCost.textContent = totalExt.value || '$0.00';
            if (extRow) extRow.style.display = 'flex';
        } else {
            if (extRow) extRow.style.display = 'none';
        }
    } else {
        var totalRegNoRange = document.getElementById('total_reg');
        var snapRegLabelNoRange = document.getElementById('snap_reg_label');
        var snapRegCostNoRange = document.getElementById('snap_reg_cost');
        
        if (snapRegLabelNoRange) snapRegLabelNoRange.textContent = 'Total Cost:';
        if (snapRegCostNoRange && totalRegNoRange) snapRegCostNoRange.textContent = totalRegNoRange.value || '$0.00';
        if (regRow) regRow.style.display = 'flex';
        if (extRow) extRow.style.display = 'none';
    }
    
    var colorList = document.getElementById('color_list');
    var snapColors = document.getElementById('snap_colors');
    if (snapColors) {
        if (colorList && colorList.options.length > 0) {
            var colors = [];
            for (var i = 0; i < colorList.options.length; i++) {
                colors.push(colorList.options[i].text);
            }
            snapColors.textContent = colors.join('\n');
        } else {
            snapColors.textContent = '';
        }
    }
}

// ============================================
// COPY SNAPSHOT TO CLIPBOARD
// ============================================
function copySnapshotToClipboard() {
    var vendorCodeEl = document.getElementById('vendor_code');
    var vendorStyleEl = document.getElementById('vendor_style');
    var styleNameEl = document.getElementById('style_name');
    var sizeRangeSelect = document.getElementById('size_range_id');
    var totalRegEl = document.getElementById('total_reg');
    var totalExtEl = document.getElementById('total_ext');
    
    var vendorCode = vendorCodeEl ? vendorCodeEl.value : 'V999';
    var vendorStyle = vendorStyleEl ? vendorStyleEl.value : '';
    var styleName = styleNameEl ? styleNameEl.value : '';
    
    var regularSizes = '';
    var extendedSizes = '';
    
    if (sizeRangeSelect && sizeRangeSelect.value) {
        var selectedOption = sizeRangeSelect.options[sizeRangeSelect.selectedIndex];
        if (selectedOption) {
            regularSizes = selectedOption.dataset.regular || '';
            extendedSizes = selectedOption.dataset.extended || '';
        }
    }
    
    var totalReg = totalRegEl ? totalRegEl.value : '$0.00';
    var totalExt = totalExtEl ? totalExtEl.value : '';
    
    // Build copy text - NO colors, just empty "Color:"
    var copyText = 'Vendor Code: ' + vendorCode + '\n';
    copyText += 'Vendor Style: ' + vendorStyle + '\n';
    copyText += 'Style Name: ' + styleName + '\n';
    
    if (regularSizes) {
        copyText += 'Sizes ' + regularSizes + ' Cost: ' + totalReg + '\n';
    } else {
        copyText += 'Total Cost: ' + totalReg + '\n';
    }
    
    // Only include extended sizes if they exist and are not empty/None
    if (extendedSizes && extendedSizes.trim() !== '' && extendedSizes.trim().toLowerCase() !== 'none' && totalExt) {
        copyText += 'Sizes ' + extendedSizes + ' Cost: ' + totalExt + '\n';
    }
    
    // Color: empty (no colors copied)
    copyText += 'Color:';
    
    // Copy to clipboard
    var textArea = document.createElement('textarea');
    textArea.value = copyText;
    textArea.style.position = 'fixed';
    textArea.style.left = '-9999px';
    textArea.style.top = '-9999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        var successful = document.execCommand('copy');
        if (successful) {
            showCopySuccess();
        } else {
            alert('Failed to copy');
        }
    } catch (err) {
        alert('Failed to copy: ' + err);
    }
    
    document.body.removeChild(textArea);
}

function showCopySuccess() {
    var btn = document.getElementById('copySnapshotBtn');
    if (btn) {
        var originalHtml = btn.innerHTML;
        btn.innerHTML = '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!';
        btn.classList.add('copied');
        
        setTimeout(function() {
            btn.innerHTML = originalHtml;
            btn.classList.remove('copied');
        }, 2000);
    }
    
    var existingToast = document.querySelector('.copy-toast');
    if (existingToast) existingToast.remove();
    
    var toast = document.createElement('div');
    toast.className = 'copy-toast';
    toast.innerHTML = '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> Copied to clipboard!';
    document.body.appendChild(toast);
    
    setTimeout(function() {
        if (toast.parentNode) toast.remove();
    }, 3000);
}

function exportCurrentStyle() {
    var vendorStyleEl = document.getElementById('vendor_style');
    var styleNameEl = document.getElementById('style_name');
    var vendorStyle = vendorStyleEl ? vendorStyleEl.value.trim() : '';
    var styleName = styleNameEl ? styleNameEl.value.trim() : '';
    
    var missing = [];
    if (!vendorStyle) missing.push('‚Ä¢ VENDOR STYLE');
    if (!styleName) missing.push('‚Ä¢ STYLE NAME');
    
    var colorList = document.getElementById('color_list');
    if (!colorList || colorList.options.length === 0) missing.push('‚Ä¢ At least ONE COLOR');
    
    var sizeRange = document.getElementById('size_range_id');
    if (!sizeRange || !sizeRange.value) missing.push('‚Ä¢ SIZE RANGE');
    
    if (missing.length > 0) {
        alert('Cannot export! Missing:\n\n' + missing.join('\n'));
        return;
    }
    
    var urlParams = new URLSearchParams(window.location.search);
    var currentVendorStyle = urlParams.get('vendor_style');
    
    if (!currentVendorStyle) {
        alert('Style not saved yet! Please save first.');
        return;
    }
    
    var csrfMeta = document.querySelector('meta[name="csrf-token"]');
    var csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';
    
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '/export-sap-single-style';
    
    var csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    var input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'vendor_style';
    input.value = currentVendorStyle;
    form.appendChild(input);
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}

// Attach click handler when page loads
document.addEventListener('DOMContentLoaded', function() {
    var copyBtn = document.getElementById('copySnapshotBtn');
    if (copyBtn) {
        copyBtn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            copySnapshotToClipboard();
            return false;
        };
    }
});

window.copySnapshotToClipboard = copySnapshotToClipboard;
window.updateSnapshotDisplay = updateSnapshotDisplay;
window.exportCurrentStyle = exportCurrentStyle;
</script>

{% if view_mode %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input, select, textarea').forEach(function(el) {
        el.disabled = true;
        el.style.backgroundColor = '#f3f4f6';
        el.style.cursor = 'not-allowed';
    });
    
    document.querySelectorAll('button').forEach(function(el) {
        var text = el.textContent.toLowerCase();
        if (text.includes('add') || text.includes('remove') || text.includes('delete')) {
            el.style.display = 'none';
        }
    });
    
    document.querySelectorAll('.linklike').forEach(function(el) {
        el.style.display = 'none';
    });
});
</script>
{% endif %}

{% endblock %}