{% extends "base.html" %}
{% block title %}Dashboard - J.A Uniforms{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard_modern.css') }}">
<style>
    .chart-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: #6B7280;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}

<div class="dashboard-container">
    
    <!-- WELCOME BANNER -->
    <div class="welcome-banner">
        <div class="welcome-content">
            <h1 id="greeting">Good morning, {{ current_user.get_display_name() }}! ‚òÄÔ∏è</h1>
            <p class="subtitle">
                <span id="current-date">Friday, October 24, 2025</span> ‚Ä¢ 
                <span id="last-updated">Last updated: just now</span>
            </p>
        </div>
    </div>
    
    <!-- MAIN CONTENT GRID (Recent Styles + Management) -->
    <div class="main-content-grid">
        
        <!-- RECENT STYLES CARD -->
        <div class="recent-styles-card">
            <div class="card-header-modern">
                <span class="icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                </span>
                <h2>Recent Styles</h2>
            </div> 
            <div id="recent-styles-list">
                {% if recent_styles %}
                    {% for style in recent_styles %}
                    <div class="recent-style-item" data-style-id="{{ style.id }}" onclick="window.location.href='/style/view?vendor_style={{ style.vendor_style }}'" style="cursor: pointer;">
                        <div class="style-info">
                            <div class="style-name">üìã {{ style.vendor_style }} - {{ style.style_name }}</div>
                            <div class="style-time">{{ style.updated_at|time_ago }}</div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="text-align: center; padding: 40px; color: #6B7280;">
                        <p>No recent styles yet. {% if current_user.is_admin() %}Create your first style!{% endif %}</p>
                    </div>
                {% endif %}
            </div>
            
            <a href="/view-all-styles" class="view-all-link">
                View All {{ total_styles }} Styles ‚Üí
            </a>
        </div>
        
        <!-- MANAGEMENT CARD -->
        <div class="management-card">
            <div class="card-header-modern">
                <span class="icon">üîß</span>
                <h2>Quick Management</h2>
            </div>
            
            <div class="management-links-grid">
                <a href="/master-costs#fabric-vendors" class="management-link">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1h8z"/>
                        <path d="M11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                    </svg>
                    Fabric Vendors
                </a>
                
                <a href="/master-costs#colors-section" class="management-link">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <circle cx="8" cy="8" r="7"/>
                    </svg>
                    Colors
                </a>
                
                <a href="/master-costs#notion-vendors" class="management-link">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1h8z"/>
                        <path d="M11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                    </svg>
                    Notion Vendors
                </a>
                
                <a href="/master-costs#variables-section" class="management-link">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                    </svg>
                    Variables
                </a>
                
                <a href="/master-costs#size-ranges-section" class="management-link">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M3 2.5a2.5 2.5 0 0 1 5 0 2.5 2.5 0 0 1 5 0v.006H15a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1v7.5a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 14.5V7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h2z"/>
                    </svg>
                    Size Ranges
                </a>
                
                <a href="/master-costs#global-settings-section" class="management-link">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492z"/>
                        <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
                    </svg>
                    Global Settings
                </a>
            </div>
            
            <div class="system-overview">
                <h3>üì¶ System Overview</h3>
                <div class="system-stat">
                    <span>Fabrics:</span>
                    <strong>{{ total_fabrics }}</strong>
                </div>
                <div class="system-stat">
                    <span>Notions:</span>
                    <strong>{{ total_notions }}</strong>
                </div>
                <div class="system-stat">
                    <span>Fabric Vendors:</span>
                    <strong>{{ total_fabric_vendors }}</strong>
                </div>
                <div class="system-stat">
                    <span>Notion Vendors:</span>
                    <strong>{{ total_notion_vendors }}</strong>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ACTION BUTTONS GRID -->
    <div class="action-buttons-grid">
        
        {% if current_user.is_admin() %}
        <div class="action-card-modern" onclick="window.location.href='/style/new'">
            <div class="action-icon-modern">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
            </div>
            <h3>New Style</h3>
            <p>Create uniform</p>
            <button class="action-btn">
                Open Wizard ‚Üí
            </button>
        </div>
        {% endif %}
        
        {% if current_user.is_admin() %}
        <div class="action-card-modern green" onclick="window.location.href='/import-excel'">
            <div class="action-icon-modern">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
            </div>
            <h3>Import Excel</h3>
            <p>Bulk upload</p>
            <button class="action-btn">
                Upload File ‚Üí
            </button>
        </div>
        {% endif %}

        <div class="action-card-modern orange" onclick="openExportModal()">
            <div class="action-icon-modern">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
            </div>
            <h3>Export All</h3>
            <p>Download SAP CSV</p>
            <button class="action-btn">
                Export Now ‚Üí
            </button>
        </div>
        
        <div class="action-card-modern purple" onclick="scrollToAnalytics()">
            <div class="action-icon-modern">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="12" y1="20" x2="12" y2="10"/>
                    <line x1="18" y1="20" x2="18" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="16"/>
                </svg>
            </div>
            <h3>Analytics</h3>
            <p>View insights</p>
            <button class="action-btn">
                View Charts ‚Üí
            </button>
        </div>     
    </div>

    
    <!-- STATS CARDS GRID -->
    <div class="stats-grid">
        
        <div class="stat-card-modern blue">
            <div class="stat-icon">üìã</div>
            <div class="stat-value" id="stat-total-styles">{{ total_styles }}</div>
            <div class="stat-label">Styles</div>
        </div>
        
        <div class="stat-card-modern green">
            <div class="stat-icon">üí∞</div>
            <div class="stat-value" id="stat-avg-cost">${{ "%.2f"|format(avg_cost) }}</div>
            <div class="stat-label">Avg Cost</div>
        </div>
        
        <div class="stat-card-modern orange">
            <div class="stat-icon">üÜï</div>
            <div class="stat-value">{{ new_this_week }}</div>
            <div class="stat-label">This Week</div>
        </div>
        
        <div class="stat-card-modern pink">
            <div class="stat-icon">üìà</div>
            <div class="stat-value">{{ price_range }}</div>
            <div class="stat-label">Range</div>
        </div>
        
        <div class="stat-card-modern purple">
            <div class="stat-icon">üèÜ</div>
            <div class="stat-value">{{ top_fabric if top_fabric != 'N/A' else '‚Äî' }}</div>
            <div class="stat-label">Top Fabric</div>
        </div>
        
    </div>
    
    <!-- ANALYTICS SECTION WITH CHART.JS -->
    <div class="analytics-section" id="analytics-section">
        <div class="analytics-header">
            <h2>
                <span>üìä</span>
                Live Analytics & Insights
            </h2>
        </div>
        
        <div class="analytics-grid">
            
            <!-- Cost Distribution -->
            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-icon">üí∞</span>
                    <h3>Cost Distribution</h3>
                </div>
                <div class="widget-content" id="costDistributionChart">
                    <div class="chart-loading">Loading chart...</div>
                </div>
            </div>
            
            <!-- Top Fabrics -->
            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-icon">üßµ</span>
                    <h3>Top Fabrics</h3>
                </div>
                <div class="widget-content" id="topFabricsChart">
                    <div class="chart-loading">Loading chart...</div>
                </div>
            </div>
            
            <!-- Compare Styles -->
            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-icon">üîÑ</span>
                    <h3>Compare Styles</h3>
                </div>
                <div class="widget-content">
                    <div class="chart-placeholder">
                        Interactive comparison table
                        <br><small>(Feature coming soon)</small>
                    </div>
                </div>
            </div>
            
            <!-- Cost Breakdown - WITH STYLE SELECTOR -->
            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-icon">ü•ß</span>
                    <h3>Cost Breakdown</h3>
                </div>
                <div class="widget-content" id="costBreakdownChart">
                    <div style="margin-bottom: 10px;">
                        <select id="costBreakdownStyleSelect" style="width: 100%; padding: 8px 12px; border: 1px solid #E5E7EB; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                            <option value="all">All Styles (Average)</option>
                        </select>
                    </div>
                    <div style="text-align: center; margin-bottom: 8px;">
                        <div id="costBreakdownTitle" style="font-size: 12px; color: #6B7280; font-weight: 500;"></div>
                        <div id="costBreakdownTotal" style="font-size: 14px; color: #1F2937; font-weight: 700;"></div>
                    </div>
                    <div style="height: 180px;">
                        <canvas id="costBreakdownChartCanvas"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Activity Trend -->
            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-icon">üìà</span>
                    <h3>Activity Trend</h3>
                </div>
                <div class="widget-content" id="activityTrendChart">
                    <div class="chart-loading">Loading chart...</div>
                </div>
            </div>
            
            <!-- Quick Insights -->
            <div class="analytics-widget">
                <div class="widget-header">
                    <span class="widget-icon">üí°</span>
                    <h3>Quick Insights</h3>
                </div>
                <div class="widget-content">
                    <ul class="insight-list" id="quickInsightsList">
                        <li>Loading insights...</li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>
    
</div>

<!-- Export Modal -->
<div id="exportModal" class="export-modal">
    <div class="export-modal-content">
        <div class="export-modal-header">
            <div>
                <h3>Export to SAP</h3>
                <div class="export-filter-info" id="exportFilterInfo">Showing all {{ total_styles }} styles</div>
            </div>
            <button class="close-modal" id="closeExportBtn">&times;</button>
        </div>
        <div class="export-modal-body">
            <div class="export-search">
                <input type="text" id="exportSearch" placeholder="Search within current view...">
            </div>
            <div class="export-select-all">
                <label>
                    <input type="checkbox" id="exportSelectAll">
                    <span>Select All (<span id="exportSelectedCount">0</span> of <span id="exportTotalCount">{{ total_styles }}</span>)</span>
                </label>
            </div>
            <div class="export-styles-list" id="exportStylesList">
                <div class="export-loading">Loading styles...</div>
            </div>
        </div>
        <div class="export-modal-footer">
            <button class="btn btn-secondary" id="cancelExportBtn">Cancel</button>
            <button class="btn btn-success" id="doExportBtn">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Export Selected
            </button>
        </div>
    </div>
</div>

<script>
// Scroll to analytics section
function scrollToAnalytics() {
    document.getElementById('analytics-section').scrollIntoView({ behavior: 'smooth' });
}
</script>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/dashboard_charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard_modern.js') }}"></script>
{% endblock %}