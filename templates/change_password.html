<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password - J.A. Uniforms</title>
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Auth CSS (same as login) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
    
    <!-- Fixed Professional Color Theme -->
    <script>
    // Fixed slate/blue-gray theme for professional appearance
    const theme = {
        gradient: 'linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%)',
        primary: 'linear-gradient(135deg, #475569 0%, #334155 100%)',
        accent: '#475569',
        pulse: 'rgba(71, 85, 105, 0.4)',
        shadow: 'rgba(71, 85, 105, 0.3)',
        filled: 'rgba(71, 85, 105, 0.05)'
    };

    // Apply theme colors
    document.documentElement.style.setProperty('--dynamic-gradient', theme.gradient);
    document.documentElement.style.setProperty('--primary-color', theme.primary);
    document.documentElement.style.setProperty('--accent-color', theme.accent);
    document.documentElement.style.setProperty('--pulse-color', theme.pulse);
    document.documentElement.style.setProperty('--shadow-color', theme.shadow);
    document.documentElement.style.setProperty('--filled-bg', theme.filled);
    </script>
    
    <!-- Password Requirements Styles -->
    <style>
    .password-requirements {
        margin-top: 0.75rem;
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }
    .req-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
    }
    .req-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.75rem;
        color: #94a3b8;
        transition: all 0.2s;
    }
    .req-item.valid {
        color: #10b981;
    }
    .req-item .req-icon {
        width: 14px;
        height: 14px;
    }
    .confirm-match {
        font-size: 0.75rem;
        margin-top: 0.5rem;
        display: none;
    }
    .confirm-match.show {
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    .confirm-match.match {
        color: #10b981;
    }
    .confirm-match.no-match {
        color: #ef4444;
    }
    .warning-banner {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 1px solid #f59e0b;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
    }
    .warning-banner i {
        color: #d97706;
        flex-shrink: 0;
        margin-top: 2px;
    }
    .warning-banner p {
        margin: 0;
        color: #92400e;
        font-size: 0.875rem;
        line-height: 1.5;
    }
    .warning-banner strong {
        color: #78350f;
    }
    </style>
</head>
<body>
    <div class="auth-container" style="background: var(--dynamic-gradient); background-size: 200% 200%; animation: gradientShift 15s ease infinite;">
        <div class="auth-blob auth-blob-1"></div>
        <div class="auth-blob auth-blob-2"></div>
        <div class="auth-blob auth-blob-3"></div>

        <div class="auth-card">
            <!-- Left Side - Logo -->
            <div class="auth-left">
                <div class="auth-logo">
                    <img src="{{ url_for('static', filename='img/logo.svg') }}" alt="J.A. Uniforms Logo" class="logo-img">
                </div>
                <div class="auth-brand">
                    <div class="auth-brand-name">J.A. Uniforms</div>
                    <div class="auth-brand-tagline">Pricing Management System</div>
                </div>
            </div>

            <!-- Right Side - Form -->
            <div class="auth-right">
                <div class="auth-header">
                    <h1 class="auth-title">üîê Change Your Password</h1>
                    <p class="auth-subtitle">Please create a new secure password to continue</p>
                </div>

                <!-- Warning Banner -->
                <div class="warning-banner">
                    <i data-feather="alert-triangle"></i>
                    <p>
                        <strong>Temporary Password Detected</strong><br>
                        For security reasons, you must change your temporary password before accessing the system.
                    </p>
                </div>

                <!-- Toast Container for Flash Messages -->
                <div class="toast-container" id="toastContainer"></div>

                <!-- Change Password Form -->
                <form class="auth-form" method="POST" action="{{ url_for('change_password') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    
                    <!-- Current/Temporary Password -->
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <div class="form-input-wrapper">
                            <i data-feather="key" class="form-input-icon"></i>
                            <input type="password" class="form-input" id="currentPassword" name="current_password" placeholder="Enter your temporary password" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('currentPassword')">
                                <i data-feather="eye" id="currentPassword-eye"></i>
                            </button>
                        </div>
                    </div>

                    <!-- New Password -->
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <div class="form-input-wrapper">
                            <i data-feather="lock" class="form-input-icon"></i>
                            <input type="password" class="form-input" id="password" name="new_password" placeholder="Create a strong password" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('password')">
                                <i data-feather="eye" id="password-eye"></i>
                            </button>
                        </div>
                        <div class="password-strength">
                            <div class="password-strength-bar" id="strengthBar"></div>
                        </div>
                        <div class="password-strength-text" id="strengthText"></div>
                        
                        <!-- Password Requirements Checklist -->
                        <div class="password-requirements" id="passwordRequirements">
                            <div class="req-grid">
                                <span class="req-item" id="req-length">
                                    <i data-feather="x-circle" class="req-icon"></i>
                                    8+ characters
                                </span>
                                <span class="req-item" id="req-uppercase">
                                    <i data-feather="x-circle" class="req-icon"></i>
                                    Uppercase (A-Z)
                                </span>
                                <span class="req-item" id="req-lowercase">
                                    <i data-feather="x-circle" class="req-icon"></i>
                                    Lowercase (a-z)
                                </span>
                                <span class="req-item" id="req-number">
                                    <i data-feather="x-circle" class="req-icon"></i>
                                    Number (0-9)
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Confirm New Password -->
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <div class="form-input-wrapper">
                            <i data-feather="lock" class="form-input-icon"></i>
                            <input type="password" class="form-input" id="confirmPassword" name="confirm_password" placeholder="Re-enter your new password" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                                <i data-feather="eye" id="confirmPassword-eye"></i>
                            </button>
                        </div>
                        <div class="confirm-match" id="confirmMatch">
                            <i data-feather="check-circle" style="width: 14px; height: 14px;"></i>
                            <span id="confirmMatchText">Passwords match</span>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="auth-submit-btn" id="submitBtn">
                        <span>Change Password</span>
                        <i data-feather="arrow-right" style="width: 20px; height: 20px;"></i>
                    </button>
                </form>

                <!-- Footer -->
                <div class="auth-footer">
                    <p class="auth-footer-text">
                        Need help? Contact your administrator.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Messages Data (Jinja2 renders JSON) -->
    <script id="flashMessages" type="application/json">
    [
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {
                        "category": "{{ category }}",
                        "message": {{ message|tojson }},
                        "icon": "{% if category == 'success' %}check-circle{% elif category == 'danger' %}alert-circle{% elif category == 'warning' %}alert-triangle{% else %}info{% endif %}"
                    }{% if not loop.last %},{% endif %}
                {% endfor %}
            {% endif %}
        {% endwith %}
    ]
    </script>

    <style>
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
        pointer-events: none;
    }

    .toast {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
        padding: 16px 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.08);
        animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        pointer-events: auto;
        min-width: 300px;
        border-left: 4px solid;
    }

    .toast-success { border-left-color: #28a745; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); }
    .toast-info { border-left-color: #17a2b8; background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); }
    .toast-warning { border-left-color: #ffc107; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); }
    .toast-danger { border-left-color: #dc3545; background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); }

    .toast i { flex-shrink: 0; width: 24px; height: 24px; }
    .toast-success i { color: #28a745; }
    .toast-info i { color: #17a2b8; }
    .toast-warning i { color: #856404; }
    .toast-danger i { color: #dc3545; }
    .toast span { flex: 1; font-size: 14px; font-weight: 500; line-height: 1.4; }

    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }

    .toast-exit { animation: slideOut 0.3s ease-in forwards; }
    </style>

    <script>
        feather.replace();
        
        // Password Requirements Validation
        document.getElementById('password').addEventListener('input', function() {
            const password = this.value;
            
            const requirements = {
                'req-length': password.length >= 8,
                'req-uppercase': /[A-Z]/.test(password),
                'req-lowercase': /[a-z]/.test(password),
                'req-number': /\d/.test(password)
            };
            
            for (const [id, passed] of Object.entries(requirements)) {
                const el = document.getElementById(id);
                if (passed) {
                    el.classList.add('valid');
                    el.querySelector('.req-icon').setAttribute('data-feather', 'check-circle');
                } else {
                    el.classList.remove('valid');
                    el.querySelector('.req-icon').setAttribute('data-feather', 'x-circle');
                }
            }
            
            feather.replace();
            
            // Update strength bar
            const passedCount = Object.values(requirements).filter(Boolean).length;
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');
            
            strengthBar.style.width = (passedCount * 25) + '%';
            
            if (passedCount === 0) {
                strengthBar.style.background = '#e2e8f0';
                strengthText.textContent = '';
            } else if (passedCount === 1) {
                strengthBar.style.background = '#ef4444';
                strengthText.textContent = 'Weak';
                strengthText.style.color = '#ef4444';
            } else if (passedCount === 2) {
                strengthBar.style.background = '#f59e0b';
                strengthText.textContent = 'Fair';
                strengthText.style.color = '#f59e0b';
            } else if (passedCount === 3) {
                strengthBar.style.background = '#3b82f6';
                strengthText.textContent = 'Good';
                strengthText.style.color = '#3b82f6';
            } else {
                strengthBar.style.background = '#10b981';
                strengthText.textContent = 'Strong';
                strengthText.style.color = '#10b981';
            }
            
            // Also check confirm password if it has value
            const confirmPassword = document.getElementById('confirmPassword');
            if (confirmPassword.value) {
                checkPasswordMatch();
            }
        });

        // Confirm Password Match
        document.getElementById('confirmPassword').addEventListener('input', checkPasswordMatch);
        
        function checkPasswordMatch() {
            const password = document.getElementById('password').value;
            const confirm = document.getElementById('confirmPassword').value;
            const matchDiv = document.getElementById('confirmMatch');
            const matchText = document.getElementById('confirmMatchText');
            const confirmInput = document.getElementById('confirmPassword');
            
            if (confirm) {
                matchDiv.classList.add('show');
                if (confirm === password) {
                    matchDiv.classList.remove('no-match');
                    matchDiv.classList.add('match');
                    matchText.textContent = 'Passwords match';
                    matchDiv.querySelector('svg').setAttribute('data-feather', 'check-circle');
                    confirmInput.style.borderColor = '#10b981';
                } else {
                    matchDiv.classList.remove('match');
                    matchDiv.classList.add('no-match');
                    matchText.textContent = 'Passwords do not match';
                    matchDiv.querySelector('svg').setAttribute('data-feather', 'x-circle');
                    confirmInput.style.borderColor = '#ef4444';
                }
                feather.replace();
            } else {
                matchDiv.classList.remove('show');
                confirmInput.style.borderColor = '';
            }
        }
        
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(inputId + '-eye');
            if (input.type === 'password') {
                input.type = 'text';
                icon.setAttribute('data-feather', 'eye-off');
            } else {
                input.type = 'password';
                icon.setAttribute('data-feather', 'eye');
            }
            feather.replace();
        }

        // Toast Notifications System
        document.addEventListener('DOMContentLoaded', function() {
            const messagesScript = document.getElementById('flashMessages');
            const messages = JSON.parse(messagesScript.textContent || '[]');
            
            const container = document.getElementById('toastContainer');
            
            messages.forEach(function(msg, index) {
                setTimeout(function() {
                    const toast = document.createElement('div');
                    toast.className = 'toast toast-' + msg.category;
                    toast.innerHTML = '<i data-feather="' + msg.icon + '"></i><span>' + msg.message + '</span>';
                    container.appendChild(toast);
                    
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                    }
                    
                    setTimeout(function() {
                        toast.classList.add('toast-exit');
                        setTimeout(function() {
                            toast.remove();
                        }, 300);
                    }, 4000);
                }, index * 150);
            });
        });
    </script>
</body>
</html>