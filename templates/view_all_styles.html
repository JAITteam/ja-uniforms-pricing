{% extends "base.html" %}
{% block title %}All Styles - J.A Uniforms{% endblock %}

{% block content %}
<style>
body { margin: 0 !important; }
body > nav + div { max-width: 100% !important; width: 100% !important; padding: 0 !important; margin: 0 !important; }
* { box-sizing: border-box; }

.page-container {
    max-width: 100% !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 1.5rem 2rem !important;
    background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
    min-height: 100vh;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.page-header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1a1a2e;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.page-header h1::before {
    content: '';
    display: inline-block;
    width: 4px;
    height: 28px;
    background: linear-gradient(180deg, #3b82f6 0%, #1d4ed8 100%);
    border-radius: 2px;
}

.btn {
    padding: 0.65rem 1.25rem;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    font-size: 0.875rem;
    white-space: nowrap;
}

.btn-export {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.35);
    padding: 0.75rem 1.5rem;
}

.btn-export:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.45);
}

.btn-export svg {
    transition: transform 0.3s;
}

.btn-export:hover svg {
    transform: translateY(2px);
}

.btn-clear {
    background: white;
    color: #64748b;
    border: 2px solid #e2e8f0;
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
}

.btn-clear:hover {
    background: #fef2f2;
    border-color: #fca5a5;
    color: #dc2626;
}

.btn-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.btn-secondary {
    background: white;
    color: #475569;
    border: 2px solid #e2e8f0;
}

.btn-secondary:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
}

.btn-danger {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    border: none;
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.35);
}

.btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.45);
}

/* REVAMPED FILTER BOX */
.filters-section {
    background: white;
    border-radius: 16px;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    border: 1px solid rgba(0,0,0,0.04);
    overflow: hidden;
}

.filters-top-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem 1.5rem;
    background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
    border-bottom: 1px solid #e2e8f0;
}

.search-box {
    flex: 1;
    position: relative;
}

.search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.75rem;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 0.9rem;
    transition: all 0.3s;
    background: white;
}

.search-box input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

.search-box svg {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
    width: 18px;
    height: 18px;
}

.dropdown-group {
    display: flex;
    gap: 0.75rem;
}

.custom-select {
    position: relative;
    min-width: 160px;
}

.custom-select select {
    width: 100%;
    padding: 0.75rem 2.5rem 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 0.875rem;
    font-weight: 500;
    background: white;
    cursor: pointer;
    transition: all 0.3s;
    appearance: none;
    color: #334155;
}

.custom-select select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

.custom-select::after {
    content: '';
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 6px solid #64748b;
    pointer-events: none;
}

.filters-bottom-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    gap: 1rem;
}

.filter-chips {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
}

.filter-chip {
    padding: 0.5rem 1.1rem;
    border: 2px solid #e2e8f0;
    background: white;
    border-radius: 25px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.3s;
    color: #64748b;
}

.filter-chip:hover {
    border-color: #3b82f6;
    color: #3b82f6;
    background: #eff6ff;
}

.filter-chip.active {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    border-color: transparent;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.filter-chip.active-secondary {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white;
    border-color: transparent;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}

.filter-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.active-filters-bar {
    display: none;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-top: 1px solid #fcd34d;
    font-size: 0.8rem;
    color: #92400e;
    align-items: center;
    gap: 0.5rem;
}

.active-filters-bar.show {
    display: flex;
}

.active-filters-bar svg {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
}

.active-filters-bar strong {
    color: #78350f;
}

/* TABLE STYLES */
.table-container {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    border: 1px solid rgba(0,0,0,0.04);
    overflow: hidden;
}

.modern-table {
    width: 100%;
    border-collapse: collapse;
}

.modern-table thead {
    background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
    border-bottom: 2px solid #e2e8f0;
}

.modern-table th {
    padding: 1rem 0.75rem;
    text-align: left;
    font-weight: 700;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: #475569;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
}

.modern-table th:hover {
    background: rgba(59, 130, 246, 0.05);
    color: #3b82f6;
}

.modern-table th.sortable::after {
    content: ' \2195';
    opacity: 0.3;
    font-size: 0.65rem;
}

.modern-table th.sort-asc::after {
    content: ' \2191';
    opacity: 1;
    color: #3b82f6;
}

.modern-table th.sort-desc::after {
    content: ' \2193';
    opacity: 1;
    color: #3b82f6;
}

.modern-table td {
    padding: 1rem 0.75rem;
    border-bottom: 1px solid #f1f5f9;
    font-size: 0.875rem;
    color: #475569;
}

.modern-table tbody tr {
    transition: all 0.2s;
}

.modern-table tbody tr:hover {
    background: linear-gradient(90deg, rgba(59, 130, 246, 0.03) 0%, transparent 100%);
}

.modern-table tbody tr.margin-high {
    border-left: 4px solid #10b981;
}

.modern-table tbody tr.margin-medium {
    border-left: 4px solid #3b82f6;
}

.modern-table tbody tr.margin-low {
    border-left: 4px solid #ef4444;
}

.vendor-style-link {
    color: #3b82f6;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s;
}

.vendor-style-link:hover {
    color: #1d4ed8;
    text-decoration: underline;
}

.favorite-star {
    cursor: pointer;
    color: #cbd5e1;
    fill: none;
    transition: all 0.3s;
}

.favorite-star.active {
    color: #fbbf24;
    fill: #fbbf24;
}

.favorite-star:hover {
    transform: scale(1.2);
    color: #f59e0b;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.35rem 0.85rem;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-active {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
}

.status-active::before {
    content: '';
    width: 6px;
    height: 6px;
    background: #10b981;
    border-radius: 50%;
}

.status-inactive {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
}

.action-buttons {
    display: flex;
    gap: 0.35rem;
}

.action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 34px;
    height: 34px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
}

.action-btn svg {
    width: 15px;
    height: 15px;
}

.action-btn.copy { color: #0891b2; }
.action-btn.copy:hover { background: #cffafe; border-color: #22d3ee; }

.action-btn.export { color: #059669; }
.action-btn.export:hover { background: #d1fae5; border-color: #34d399; }

.action-btn.delete { color: #dc2626; }
.action-btn.delete:hover { background: #fee2e2; border-color: #f87171; }

/* PAGINATION */
.pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
    border-top: 1px solid #e2e8f0;
}

.pagination-info {
    color: #64748b;
    font-size: 0.85rem;
}

.pagination-controls {
    display: flex;
    gap: 0.35rem;
}

.page-btn {
    padding: 0.5rem 0.85rem;
    border: 2px solid #e2e8f0;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.2s;
    min-width: 38px;
    color: #64748b;
}

.page-btn:hover:not(:disabled) {
    border-color: #3b82f6;
    color: #3b82f6;
    background: #eff6ff;
}

.page-btn.active {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    border-color: transparent;
}

.page-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.items-per-page {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: #64748b;
}

.items-per-page select {
    padding: 0.5rem 0.75rem;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
}

/* MODAL BASE STYLES */
.modal-overlay {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(8px);
}

.modal-overlay.active {
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-box {
    background: white;
    border-radius: 20px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 25px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
    overflow: hidden;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 1.75rem;
    border-bottom: 1px solid #e2e8f0;
    background: linear-gradient(180deg, #f8fafc 0%, white 100%);
    position: relative;
}

.modal-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
    color: #1e293b;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.modal-header-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-header-icon svg {
    width: 20px;
    height: 20px;
}

.modal-close {
    background: #f1f5f9;
    border: none;
    font-size: 1.5rem;
    color: #64748b;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    transition: all 0.2s;
}

.modal-close:hover {
    background: #fee2e2;
    color: #dc2626;
}

.modal-body {
    padding: 1.5rem 1.75rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding: 1.25rem 1.75rem;
    border-top: 1px solid #e2e8f0;
    background: linear-gradient(180deg, white 0%, #f8fafc 100%);
}

.modal-footer .btn {
    padding: 0.75rem 1.5rem;
}

/* EXPORT MODAL */
.export-modal .modal-header::before {
    background: linear-gradient(90deg, #10b981 0%, #059669 100%);
}

.export-modal .modal-box {
    max-width: 650px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
}

.export-filter-info {
    font-size: 0.8rem;
    color: #64748b;
    margin-top: 0.25rem;
}

.export-modal .modal-body {
    overflow-y: auto;
    flex: 1;
}

.export-search {
    margin-bottom: 1rem;
}

.export-search input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 0.9rem;
}

.export-search input:focus {
    outline: none;
    border-color: #3b82f6;
}

.export-select-all {
    padding: 1rem 1.25rem;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border-radius: 12px;
    margin-bottom: 1rem;
    border: 2px solid #a7f3d0;
}

.export-select-all label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    margin: 0;
    font-weight: 600;
    color: #065f46;
}

.export-select-all input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: #10b981;
}

.export-styles-list {
    max-height: 350px;
    overflow-y: auto;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
}

.export-style-item {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #f1f5f9;
    transition: all 0.2s;
}

.export-style-item:last-child {
    border-bottom: none;
}

.export-style-item:hover {
    background: #f8fafc;
}

.export-style-item label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    margin: 0;
}

.export-style-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #10b981;
}

.export-style-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
}

.export-style-info strong {
    color: #1e293b;
    font-size: 0.95rem;
}

.export-style-info span {
    color: #475569;
    font-size: 0.85rem;
}

.export-style-info small {
    color: #64748b;
    font-size: 0.8rem;
}

.no-results {
    text-align: center;
    padding: 2rem;
    color: #64748b;
}
</style>

<div class="page-container">
    <div class="page-header">
        <h1>All Styles</h1>
    </div>
    
    <!-- FILTER BOX -->
    <div class="filters-section">
        <div class="filters-top-row">
            <div class="search-box">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <input type="text" id="searchInput" placeholder="Search vendor style, name, or fabric...">
            </div>
            <div class="dropdown-group">
                <div class="custom-select">
                    <select id="genderFilter">
                        <option value="">All Genders</option>
                        <option value="MENS">MENS</option>
                        <option value="LADIES">LADIES</option>
                        <option value="UNISEX">UNISEX</option>
                    </select>
                </div>
                <div class="custom-select">
                    <select id="costFilter">
                        <option value="">All Costs</option>
                        <option value="0-50">$0 - $50</option>
                        <option value="50-100">$50 - $100</option>
                        <option value="100+">$100+</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="filters-bottom-row">
            <div class="filter-chips">
                <button class="filter-chip active" data-filter="all">All</button>
                <button class="filter-chip" data-filter="high-margin">High Margin (65%+)</button>
                <button class="filter-chip" data-filter="low-margin">Low Margin</button>
                {% if permissions.can_edit %}
                <button class="filter-chip" data-filter="favorites">Favorites</button>
                {% endif %}
                <button class="filter-chip" data-filter="recent">Today</button>
                <button class="filter-chip" data-filter="week">This Week</button>
            </div>
            <div class="filter-actions">
                <button class="btn btn-clear" id="clearFiltersBtn">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Clear All
                </button>
                <button class="btn btn-export" id="openExportBtn">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Export to SAP
                </button>
            </div>
        </div>
        
        <div class="active-filters-bar" id="activeFiltersBar">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
            </svg>
            <span>Active filters: <strong id="activeFiltersList"></strong> â€” <span id="filteredCount">0</span> styles found</span>
        </div>
    </div>

    <div class="table-container">
        <table class="modern-table" id="stylesTable">
            <thead>
                <tr>
                    <th class="sortable" data-sort="vendor_style">Vendor Style</th>
                    <th class="sortable" data-sort="style_name">Style Name</th>
                    <th class="sortable" data-sort="gender">Gender</th>
                    <th class="sortable" data-sort="cost">Cost</th>
                    <th class="sortable" data-sort="margin">Margin</th>
                    <th class="sortable" data-sort="updated_at">Modified</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for style in styles %}
                {% set actual_margin = ((style.suggested_price - style.get_total_cost()) / style.suggested_price * 100) if style.suggested_price and style.suggested_price > 0 else style.base_margin_percent %}
                <tr class="{% if actual_margin >= 65 %}margin-high{% elif actual_margin >= 50 %}margin-medium{% else %}margin-low{% endif %}"
                    data-id="{{ style.id }}"
                    data-vendor-style="{{ style.vendor_style }}"
                    data-vendor-style-lower="{{ style.vendor_style|lower }}"
                    data-style-name="{{ style.style_name }}"
                    data-style-name-lower="{{ style.style_name|lower }}"
                    data-gender="{{ style.gender }}"
                    data-cost="{{ style.get_total_cost() }}"
                    data-margin="{{ actual_margin|round(1) }}"
                    data-updated="{{ style.updated_at.isoformat() if style.updated_at else '' }}"
                    data-favorite="{{ 'true' if style.is_favorite else 'false' }}"
                    data-visible="true">
                    
                    <td style="display: flex; align-items: center; gap: 0.5rem;">
                        {% if permissions.can_edit %}
                        <svg class="favorite-star {% if style.is_favorite %}active{% endif %}" 
                            data-style-id="{{ style.id }}"
                            width="18" height="18" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" 
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        {% endif %}
                        <a href="/style/view?vendor_style={{ style.vendor_style }}" class="vendor-style-link">{{ style.vendor_style }}</a>
                    </td>
                    <td>{{ style.style_name }}</td>
                    <td>{{ style.gender }}</td>
                    <td><strong>${{ "%.2f"|format(style.get_total_cost()) }}</strong></td>
                    <td>
                        {% if actual_margin >= 65 %}
                        <span style="font-weight: 700; color: #059669;">{{ actual_margin|round(1) }}%</span>
                        {% elif actual_margin >= 50 %}
                        <span style="font-weight: 700; color: #3b82f6;">{{ actual_margin|round(1) }}%</span>
                        {% else %}
                        <span style="font-weight: 700; color: #dc2626;">{{ actual_margin|round(1) }}%</span>
                        {% endif %}
                    </td>
                    <td>
                        <small style="color: #64748b;">{{ style.updated_at.strftime('%b %d, %Y') if style.updated_at else 'N/A' }}</small>
                    </td>
                    <td>
                        <span class="status-badge {% if style.is_active %}status-active{% else %}status-inactive{% endif %}">
                            {{ 'Active' if style.is_active else 'Inactive' }}
                        </span>
                    </td>
                    
                    <td>
                        <div class="action-buttons">
                            {% if permissions.can_edit %}
                            <button class="action-btn copy" title="Duplicate Style" data-style-id="{{ style.id }}">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                            {% endif %}
                            <button class="action-btn export" title="Export Style" data-style-id="{{ style.id }}">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                            </button>
                            {% if permissions.can_delete %}
                            <button class="action-btn delete" title="Delete Style" data-style-id="{{ style.id }}" data-vendor-style="{{ style.vendor_style }}">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="pagination">
            <div class="pagination-info">
                Showing <strong id="showingFrom">1</strong>-<strong id="showingTo">50</strong> of <strong id="totalRows">{{ total_styles }}</strong> styles
            </div>
            <div class="items-per-page">
                <span>Show:</span>
                <select id="itemsPerPage">
                    <option value="25">25</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div class="pagination-controls" id="paginationControls"></div>
        </div>
    </div>
</div>

<!-- DELETE CONFIRMATION MODAL -->
<!-- DELETE MODAL - Uses delete_modal.css -->
<div id="deleteModal" class="delete-modal">
    <div class="delete-modal-overlay"></div>
    <div class="delete-modal-content">
        <div class="delete-modal-header">
            <div class="delete-modal-header-left">
                <div class="delete-modal-icon">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </div>
                <h3 class="delete-modal-title">Delete Style</h3>
            </div>
            <button class="delete-modal-close" id="closeDeleteModal">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="delete-modal-body">
            <p>Are you sure you want to delete <strong id="deleteStyleName"></strong>? This action cannot be undone and will permanently remove all associated data.</p>
        </div>
        <div class="delete-modal-footer">
            <button class="delete-modal-btn delete-modal-btn-cancel" id="cancelDeleteBtn">Cancel</button>
            <button class="delete-modal-btn delete-modal-btn-delete" id="confirmDeleteBtn">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                Delete
            </button>
        </div>
    </div>
</div>

<!-- EXPORT MODAL -->
<div id="exportModal" class="modal-overlay export-modal">
    <div class="modal-box">
        <div class="modal-header">
            <div>
                <h3>Export to SAP</h3>
                <div class="export-filter-info" id="exportFilterInfo">Showing all styles</div>
            </div>
            <button class="modal-close" id="closeExportBtn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="export-search">
                <input type="text" id="exportSearch" placeholder="Search within current view...">
            </div>
            <div class="export-select-all">
                <label>
                    <input type="checkbox" id="exportSelectAll">
                    <span>Select All (<span id="exportSelectedCount">0</span> of <span id="exportTotalCount">0</span>)</span>
                </label>
            </div>
            <div class="export-styles-list" id="exportStylesList"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelExportBtn">Cancel</button>
            <button class="btn btn-export" id="doExportBtn">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Export Selected
            </button>
        </div>
    </div>
</div>

<script>
(function() {
    "use strict";
    
    var currentSort = { column: "updated_at", direction: "desc" };
    var currentPage = 1;
    var itemsPerPage = 50;
    var filteredRows = [];
    var pendingDeleteId = null;
    
    var activeFilters = {
        "high-margin": false,
        "low-margin": false,
        "favorites": false,
        "recent": false,
        "week": false
    };

    function init() {
        bindEvents();
        // Force descending sort on updated_at
        currentSort = { column: "", direction: "" };
        sortTable("updated_at", "desc");
    }
    function bindEvents() {
        document.getElementById("searchInput").addEventListener("keyup", applyFilters);
        document.getElementById("genderFilter").addEventListener("change", applyFilters);
        document.getElementById("costFilter").addEventListener("change", applyFilters);
        document.getElementById("clearFiltersBtn").addEventListener("click", clearFilters);
        document.getElementById("itemsPerPage").addEventListener("change", changeItemsPerPage);
        
        // Export modal
        document.getElementById("openExportBtn").addEventListener("click", openExportModal);
        document.getElementById("closeExportBtn").addEventListener("click", closeExportModal);
        document.getElementById("cancelExportBtn").addEventListener("click", closeExportModal);
        document.getElementById("exportSearch").addEventListener("keyup", filterExportList);
        document.getElementById("exportSelectAll").addEventListener("change", toggleExportSelectAll);
        document.getElementById("doExportBtn").addEventListener("click", exportSelectedFromModal);
        
        // Delete modal
        document.getElementById("closeDeleteModal").addEventListener("click", closeDeleteModal);
        document.getElementById("cancelDeleteBtn").addEventListener("click", closeDeleteModal);
        document.getElementById("confirmDeleteBtn").addEventListener("click", executeDelete);
        
        document.querySelectorAll(".filter-chip").forEach(function(chip) {
            chip.addEventListener("click", function() {
                handleFilterClick(this.getAttribute("data-filter"), this);
            });
        });
        
        document.querySelectorAll("th.sortable").forEach(function(th) {
            th.addEventListener("click", function() {
                sortTable(this.getAttribute("data-sort"));
            });
        });
        
        document.querySelectorAll(".favorite-star").forEach(function(star) {
            star.addEventListener("click", function() {
                toggleFavorite(this.getAttribute("data-style-id"), this);
            });
        });
        
        document.querySelectorAll(".action-btn.copy").forEach(function(btn) {
            btn.addEventListener("click", function(e) {
                e.preventDefault();
                e.stopPropagation();
                duplicateStyle(this.getAttribute("data-style-id"));
            });
        });
        
        document.querySelectorAll(".action-btn.export").forEach(function(btn) {
            btn.addEventListener("click", function(e) {
                e.preventDefault();
                e.stopPropagation();
                quickExport(this.getAttribute("data-style-id"));
            });
        });
        
        document.querySelectorAll(".action-btn.delete").forEach(function(btn) {
            btn.addEventListener("click", function(e) {
                e.preventDefault();
                e.stopPropagation();
                showDeleteModal(this.getAttribute("data-style-id"), this.getAttribute("data-vendor-style"));
            });
        });
        
        // Close modals on overlay click
        document.getElementById("exportModal").addEventListener("click", function(e) {
            if (e.target === this) closeExportModal();
        });
        
        // Delete modal - click on overlay to close
        var deleteOverlay = document.querySelector("#deleteModal .delete-modal-overlay");
        if (deleteOverlay) {
            deleteOverlay.addEventListener("click", closeDeleteModal);
        }
    }

    // DELETE MODAL FUNCTIONS
    function showDeleteModal(styleId, vendorStyle) {
        pendingDeleteId = styleId;
        document.getElementById("deleteStyleName").textContent = vendorStyle;
        document.getElementById("deleteModal").classList.add("active");
    }
    
    function closeDeleteModal() {
        pendingDeleteId = null;
        document.getElementById("deleteModal").classList.remove("active");
    }
    
    function executeDelete() {
        if (!pendingDeleteId) return;
        
        var styleId = pendingDeleteId;
        closeDeleteModal();
        
        var csrfMeta = document.querySelector("meta[name='csrf-token']");
        var csrfToken = csrfMeta ? csrfMeta.getAttribute("content") : "";
        
        fetch("/api/style/delete/" + styleId, { 
            method: "DELETE",
            headers: { "X-CSRFToken": csrfToken }
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                window.location.reload();
            } else {
                alert("Error: " + (data.error || "Could not delete style"));
            }
        })
        .catch(function(error) {
            alert("Error: " + error);
        });
    }

    function handleFilterClick(filter, element) {
        if (filter === "all") {
            for (var key in activeFilters) {
                activeFilters[key] = false;
            }
            document.querySelectorAll(".filter-chip").forEach(function(chip) {
                chip.classList.remove("active", "active-secondary");
            });
            element.classList.add("active");
        } else {
            activeFilters[filter] = !activeFilters[filter];
            
            var allChip = document.querySelector(".filter-chip[data-filter='all']");
            
            if (activeFilters[filter]) {
                element.classList.add("active-secondary");
                allChip.classList.remove("active");
            } else {
                element.classList.remove("active-secondary");
            }
            
            var anyActive = false;
            for (var key in activeFilters) {
                if (activeFilters[key]) {
                    anyActive = true;
                    break;
                }
            }
            
            if (!anyActive) {
                allChip.classList.add("active");
            }
        }
        
        applyFilters();
    }

    function applyFilters() {
        var searchValue = document.getElementById("searchInput").value.toLowerCase();
        var genderValue = document.getElementById("genderFilter").value;
        var costValue = document.getElementById("costFilter").value;
        var allRows = Array.from(document.querySelectorAll("#tableBody tr"));
        
        filteredRows = [];
        
        allRows.forEach(function(row) {
            var text = row.textContent.toLowerCase();
            var gender = row.getAttribute("data-gender");
            var cost = parseFloat(row.getAttribute("data-cost"));
            var margin = parseFloat(row.getAttribute("data-margin"));
            var favorite = row.getAttribute("data-favorite") === "true";
            var updatedStr = row.getAttribute("data-updated");
            
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            
            var rowDate = updatedStr ? new Date(updatedStr) : new Date("1970-01-01");
            rowDate.setHours(0, 0, 0, 0);
            
            var daysDiff = Math.floor((today - rowDate) / (1000 * 60 * 60 * 24));
            
            var showRow = true;
            
            if (searchValue && text.indexOf(searchValue) === -1) showRow = false;
            if (genderValue && gender !== genderValue) showRow = false;
            
            if (costValue) {
                if (costValue === "0-50" && cost > 50) showRow = false;
                if (costValue === "50-100" && (cost < 50 || cost > 100)) showRow = false;
                if (costValue === "100+" && cost < 100) showRow = false;
            }
            
            if (activeFilters["high-margin"] && margin < 65) showRow = false;
            if (activeFilters["low-margin"] && margin >= 50) showRow = false;
            if (activeFilters["favorites"] && !favorite) showRow = false;
            if (activeFilters["recent"] && daysDiff !== 0) showRow = false;
            if (activeFilters["week"] && daysDiff > 7) showRow = false;
            
            row.setAttribute("data-visible", showRow ? "true" : "false");
            
            if (showRow) {
                filteredRows.push(row);
            }
        });
        
        updateActiveFiltersInfo();
        currentPage = 1;
        updatePagination();
    }

    function updateActiveFiltersInfo() {
        var activeList = [];
        var filterLabels = {
            "high-margin": "High Margin",
            "low-margin": "Low Margin",
            "favorites": "Favorites",
            "recent": "Today",
            "week": "This Week"
        };
        
        for (var key in activeFilters) {
            if (activeFilters[key]) {
                activeList.push(filterLabels[key]);
            }
        }
        
        var genderVal = document.getElementById("genderFilter").value;
        var costVal = document.getElementById("costFilter").value;
        var searchVal = document.getElementById("searchInput").value;
        
        if (genderVal) activeList.push(genderVal);
        if (costVal) activeList.push(costVal);
        if (searchVal) activeList.push("\"" + searchVal + "\"");
        
        var bar = document.getElementById("activeFiltersBar");
        var listEl = document.getElementById("activeFiltersList");
        var countEl = document.getElementById("filteredCount");
        
        if (activeList.length > 0) {
            listEl.textContent = activeList.join(" + ");
            countEl.textContent = filteredRows.length;
            bar.classList.add("show");
        } else {
            bar.classList.remove("show");
        }
    }

    function sortTable(column, forceDirection) {
        var table = document.getElementById("stylesTable");
        var tbody = table.querySelector("tbody");
        var rows = Array.from(tbody.querySelectorAll("tr"));
        
        if (forceDirection) {
            currentSort.column = column;
            currentSort.direction = forceDirection;
        } else if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === "asc" ? "desc" : "asc";
        } else {
            currentSort.column = column;
            currentSort.direction = "asc";
        }
        table.querySelectorAll("th").forEach(function(th) {
            th.classList.remove("sort-asc", "sort-desc");
        });
        
        var targetTh = table.querySelector("th[data-sort='" + column + "']");
        if (targetTh) {
            targetTh.classList.add(currentSort.direction === "asc" ? "sort-asc" : "sort-desc");
        }
        
        rows.sort(function(a, b) {
            var aVal, bVal;
            switch(column) {
                case "vendor_style": 
                    aVal = a.getAttribute("data-vendor-style-lower") || ""; 
                    bVal = b.getAttribute("data-vendor-style-lower") || ""; 
                    break;
                case "style_name": 
                    aVal = a.getAttribute("data-style-name-lower") || ""; 
                    bVal = b.getAttribute("data-style-name-lower") || ""; 
                    break;
                case "gender": 
                    aVal = a.getAttribute("data-gender") || ""; 
                    bVal = b.getAttribute("data-gender") || ""; 
                    break;
                case "cost": 
                    aVal = parseFloat(a.getAttribute("data-cost")) || 0; 
                    bVal = parseFloat(b.getAttribute("data-cost")) || 0; 
                    break;
                case "margin": 
                    aVal = parseFloat(a.getAttribute("data-margin")) || 0; 
                    bVal = parseFloat(b.getAttribute("data-margin")) || 0; 
                    break;
                case "updated_at": 
                    aVal = new Date(a.getAttribute("data-updated") || "1970-01-01"); 
                    bVal = new Date(b.getAttribute("data-updated") || "1970-01-01"); 
                    break;
                default: 
                    return 0;
            }
            if (aVal < bVal) return currentSort.direction === "asc" ? -1 : 1;
            if (aVal > bVal) return currentSort.direction === "asc" ? 1 : -1;
            return 0;
        });
        
        rows.forEach(function(row) { tbody.appendChild(row); });
        applyFilters();
    }

    function clearFilters() {
        document.getElementById("searchInput").value = "";
        document.getElementById("genderFilter").value = "";
        document.getElementById("costFilter").value = "";
        
        for (var key in activeFilters) {
            activeFilters[key] = false;
        }
        
        document.querySelectorAll(".filter-chip").forEach(function(chip) {
            chip.classList.remove("active", "active-secondary");
        });
        document.querySelector(".filter-chip[data-filter='all']").classList.add("active");
        
        applyFilters();
    }

    function updatePagination() {
        var allRows = Array.from(document.querySelectorAll("#tableBody tr"));
        var totalFiltered = filteredRows.length;
        var totalPages = Math.ceil(totalFiltered / itemsPerPage);
        
        if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;
        
        var startIndex = (currentPage - 1) * itemsPerPage;
        var endIndex = startIndex + itemsPerPage;
        
        allRows.forEach(function(row) { row.style.display = "none"; });
        
        filteredRows.forEach(function(row, index) {
            if (index >= startIndex && index < endIndex) {
                row.style.display = "";
            }
        });
        
        var showFrom = totalFiltered > 0 ? startIndex + 1 : 0;
        var showTo = Math.min(endIndex, totalFiltered);
        
        document.getElementById("showingFrom").textContent = showFrom;
        document.getElementById("showingTo").textContent = showTo;
        document.getElementById("totalRows").textContent = totalFiltered;
        
        renderPaginationControls(totalPages);
    }

    function renderPaginationControls(totalPages) {
        var controls = document.getElementById("paginationControls");
        controls.innerHTML = "";
        
        var prevBtn = document.createElement("button");
        prevBtn.className = "page-btn";
        prevBtn.innerHTML = "&laquo;";
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener("click", function() {
            if (currentPage > 1) { currentPage--; updatePagination(); }
        });
        controls.appendChild(prevBtn);
        
        var startPage = Math.max(1, currentPage - 2);
        var endPage = Math.min(totalPages, startPage + 4);
        if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);
        
        for (var i = startPage; i <= endPage; i++) {
            var btn = document.createElement("button");
            btn.className = "page-btn" + (i === currentPage ? " active" : "");
            btn.textContent = i;
            (function(page) {
                btn.addEventListener("click", function() {
                    currentPage = page;
                    updatePagination();
                });
            })(i);
            controls.appendChild(btn);
        }
        
        var nextBtn = document.createElement("button");
        nextBtn.className = "page-btn";
        nextBtn.innerHTML = "&raquo;";
        nextBtn.disabled = currentPage === totalPages || totalPages === 0;
        nextBtn.addEventListener("click", function() {
            if (currentPage < totalPages) { currentPage++; updatePagination(); }
        });
        controls.appendChild(nextBtn);
    }

    function changeItemsPerPage() {
        itemsPerPage = parseInt(document.getElementById("itemsPerPage").value);
        currentPage = 1;
        updatePagination();
    }

    function duplicateStyle(styleId) {
        if (confirm("Duplicate this style?")) {
            window.location.href = "/style/new?duplicate_from_id=" + styleId;
        }
    }

    function toggleFavorite(styleId, element) {
        var isFavorite = element.classList.contains("active");
        
        fetch("/api/style/" + styleId + "/favorite", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({is_favorite: !isFavorite})
        })
        .then(function(response) {
            if (response.ok) {
                element.classList.toggle("active");
                element.closest("tr").setAttribute("data-favorite", (!isFavorite).toString());
            }
        });
    }

    function quickExport(styleId) {
        submitExportForm([parseInt(styleId)], false);  // Default: no empty variable rows
    }

    function openExportModal() {
        var exportList = document.getElementById("exportStylesList");
        exportList.innerHTML = "";
        
        if (filteredRows.length === 0) {
            exportList.innerHTML = '<div class="no-results">No styles match current filters</div>';
        } else {
            filteredRows.forEach(function(row) {
                var id = row.getAttribute("data-id");
                var vendorStyle = row.getAttribute("data-vendor-style");
                var styleName = row.getAttribute("data-style-name");
                var gender = row.getAttribute("data-gender");
                var cost = parseFloat(row.getAttribute("data-cost")).toFixed(2);
                
                var item = document.createElement("div");
                item.className = "export-style-item";
                item.setAttribute("data-search", (vendorStyle + " " + styleName).toLowerCase());
                item.innerHTML = 
                    '<label>' +
                        '<input type="checkbox" class="export-style-checkbox" value="' + id + '">' +
                        '<div class="export-style-info">' +
                            '<strong>' + vendorStyle + '</strong>' +
                            '<span>' + styleName + '</span>' +
                            '<small>' + gender + ' &bull; $' + cost + '</small>' +
                        '</div>' +
                    '</label>';
                exportList.appendChild(item);
            });
            
            document.querySelectorAll(".export-style-checkbox").forEach(function(cb) {
                cb.addEventListener("change", updateExportCount);
            });
        }
        
        var filterInfo = document.getElementById("exportFilterInfo");
        var activeListEl = document.getElementById("activeFiltersList");
        if (activeListEl && activeListEl.textContent) {
            filterInfo.textContent = "Filtered by: " + activeListEl.textContent + " (" + filteredRows.length + " styles)";
        } else {
            filterInfo.textContent = "Showing all " + filteredRows.length + " styles";
        }
        
        document.getElementById("exportTotalCount").textContent = filteredRows.length;
        document.getElementById("exportSelectAll").checked = false;
        updateExportCount();
        
        document.getElementById("exportModal").classList.add("active");
    }

    function closeExportModal() {
        document.getElementById("exportModal").classList.remove("active");
    }

    function filterExportList() {
        var searchValue = document.getElementById("exportSearch").value.toLowerCase();
        document.querySelectorAll(".export-style-item").forEach(function(item) {
            var searchData = item.getAttribute("data-search") || "";
            item.style.display = searchData.indexOf(searchValue) !== -1 ? "" : "none";
        });
    }

    function toggleExportSelectAll() {
        var selectAll = document.getElementById("exportSelectAll");
        document.querySelectorAll(".export-style-checkbox").forEach(function(cb) {
            if (cb.closest(".export-style-item").style.display !== "none") {
                cb.checked = selectAll.checked;
            }
        });
        updateExportCount();
    }

    function updateExportCount() {
        var checked = document.querySelectorAll(".export-style-checkbox:checked").length;
        document.getElementById("exportSelectedCount").textContent = checked;
    }

    function exportSelectedFromModal() {
        var checkboxes = document.querySelectorAll(".export-style-checkbox:checked");
        var checked = [];
        checkboxes.forEach(function(cb) { checked.push(parseInt(cb.value)); });
        
        if (checked.length === 0) {
            alert("Please select at least one style to export");
            return;
        }
        
        // Get variable option
        var variableOption = document.querySelector('input[name="variableOption"]:checked');
        var includeEmptyVars = variableOption ? variableOption.value === "include_empty" : false;
        
        closeExportModal();
        submitExportForm(checked, includeEmptyVars);
    }

    function submitExportForm(styleIds, includeEmptyVars) {
        var csrfMeta = document.querySelector("meta[name='csrf-token']");
        var csrfToken = csrfMeta ? csrfMeta.getAttribute("content") : "";
        
        var form = document.createElement("form");
        form.method = "POST";
        form.action = "/export-sap-format";
        
        var csrfInput = document.createElement("input");
        csrfInput.type = "hidden";
        csrfInput.name = "csrf_token";
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        var input = document.createElement("input");
        input.type = "hidden";
        input.name = "style_ids";
        input.value = JSON.stringify(styleIds);
        form.appendChild(input);
        
        // Add variable option
        var varInput = document.createElement("input");
        varInput.type = "hidden";
        varInput.name = "include_empty_vars";
        varInput.value = includeEmptyVars ? "1" : "0";
        form.appendChild(varInput);
        
        document.body.appendChild(form);
        form.submit();
    }

    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
    } else {
        init();
    }
})();
</script>

{% endblock %}

